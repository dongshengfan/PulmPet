<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>assets\scripts\components\scene\play.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-elements">Elements</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/CircularList.html">CircularList</a></li>
                                <li><a href="../classes/CircularListActionsAnimal.html">CircularListActionsAnimal</a></li>
                                <li><a href="../classes/List.html">List</a></li>
                                <li><a href="../classes/Play.html">Play</a></li>
                            </ul>
                
                                <ul id="api-elements" class="apis elements">
                                    <li><a href="../elements/{number}.html">&lt;{number}&gt;</a></li>
                                </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: assets\scripts\components\scene\play.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
import { APICore }from &#x27;../../build/build-ts&#x27;;

/**
 * Состояние игры.
 * @type {StatGame}
 * @static
 * @element {number} sleep бездействие.
 * @element {number} openMenu открытие меню игры.
 * @element {number} openMenuAnimal открытие меню животного.
 * @element {number} createAnimal создание животного.
 * @element {number} moveMap движение карты пользователем.
 */
const StatGame = {
    sleep: 0,
    openMenu: 1,
    openMenuAnimal: 2,
    createAnimal: 3,
    moveMap: 4,
};

/**
 * Управляет представлнием.
 * @class Play
 */
cc.Class({
    extends: cc.Component,

    properties: {
        nodeWindow: cc.Node,//окно игры
        nodeBoxCreateAnimal: cc.Node,//всплывающий бокс с животными
        nodeBoxCharacteristicsAnimal: cc.Node,//всплывающий бокс с характеристиками животного
        nodeBasket: cc.Node,//корзина для удаления животного
        nodeFieldAnimals: cc.Node,//поле жизнедеятельности животных
        nodeBoxMap: cc.Node,//бокс с картой
        nodeMap: cc.Node,//поле карты
        nodeMenu: cc.Node,//поле меню игры
        nodeMenuAnimal: cc.Node,//нод меню животного
        nodeMaskCreatedAnimal: cc.Node,//маска для создания животных

        _targetAnimal: cc.Node,//нод животного в таргете
        _pointTargetAnimal: cc.v2,//точка назначения животного в таргете
        _targetControllerAnimal: cc.Node,//контроллер животного в таргете
        _centreWindowPoint: null,//точка середины экрана
    },

    /**
     * Инициализация конроллера представления.
     * @method onLoad
     */
    onLoad(){
        this._init();

        this.node.on(&#x27;createAnimal&#x27;, this.onAnimalCreated.bind(this));
        this.node.on(&#x27;openBoxFromAnimal&#x27;, this.onOpenBoxFromAnimal.bind(this));
        this.node.on(&#x27;closeBoxFromAnimal&#x27;, this.onCloseBoxFromAnimal.bind(this));
        this.node.on(&#x27;openBoxMenuPlay&#x27;, this.onOpenBoxMenuPlay.bind(this));
        this.node.on(&#x27;closeBoxMenuPlay&#x27;, this.onCloseBoxMenuPlay.bind(this));

        this.node.on(&#x27;openBoxFromCharacteristicsAnimal&#x27;, this.onOpenBoxFromCharacteristicsAnimal.bind(this));
        this.node.on(&#x27;closeBoxFromCharacteristicsAnimal&#x27;, this.onCloseBoxFromCharacteristicsAnimal.bind(this));
        this.node.on(&#x27;startDragAndDropAnimal&#x27;, this.onStartDragAndDropAnimal.bind(this));
        this.node.on(&#x27;dragAndDropAnimal&#x27;, this.onDragAndDropAnimal.bind(this));
        this.node.on(&#x27;stopDragAndDropAnimal&#x27;, this.onStopDragAndDropAnimal.bind(this));
        this.node.on(&#x27;motionAnimal&#x27;, this.onMotionAnimal.bind(this));
        this.node.on(&#x27;startMotionAnimal&#x27;, this.onStartMotionAnimal.bind(this));
        this.node.on(&#x27;endMotionAnimal&#x27;, this.onEndMotionAnimal.bind(this));
        this.node.on(&#x27;openMenuAnimal&#x27;, this.onOpenMenuAnimal.bind(this));
        this.node.on(&#x27;closeMenuAnimal&#x27;, this.onCloseMenuAnimal.bind(this));

        this.node.on(&#x27;voiceAnimal&#x27;, this.onVoiceAnimal.bind(this));

        this.node.on(&#x27;basketActive&#x27;, this.onBasketActive.bind(this));
        this.node.on(&#x27;basketSleep&#x27;, this.onBasketSleep.bind(this));
        this.node.on(&#x27;basketWork&#x27;, this.onBasketWork.bind(this));

        this.node.on(&#x27;touchOnMap&#x27;, this.onTouchOnMap.bind(this));
        this.node.on(&#x27;touchMoveOnMap&#x27;, this.onTouchMoveOnMap.bind(this));
        this.node.on(&#x27;touchEndMoveOnMap&#x27;, this.onTouchEndMoveOnMap.bind(this));
        this.node.on(&#x27;finishMoveCameraToAnimal&#x27;, this.onFinishMoveCameraToAnimal.bind(this));
    },

    /**
     * Инициализация данных.
     * @method _init
     * @private
     */
    _init(){
        this._api = APICore.instance();

        this._stateGame = StatGame.sleep;

        this._targetSizeWith = 0;//временные размеры ширины животного в таргете. Для сохранения
        this._targetSizeHeight = 0;//временные размеры высоты животного в таргете. Для сохранения

        this._pointTargetAnimal = cc.v2(0, 0);//точка назначения животного в таргет
        this._targetAnimal = null; //нод животного в таргете
        this._controllerAnimal = null;//контроллер животного (только 1 того что в таргете)
        this._centreWindowPoint = cc.v2(this.node.width / 2, this.node.height / 2);
        this._controllerCircularMenu = this.nodeMenuAnimal.getComponent(&#x27;circular-list-actions-animal&#x27;);
        this._boxCreateAnimal = this.nodeBoxCreateAnimal.getComponent(&#x27;box-create-animal&#x27;);
        this._boxCharacteristicsAnimal = this.nodeBoxCharacteristicsAnimal.getComponent(&#x27;box-characteristics-animal&#x27;);
        this._controllerBasket = this.nodeBasket.getComponent(&#x27;basket-animal&#x27;);
        this._controllerMap = this.nodeMap.getComponent(&#x27;controller-map&#x27;);

    },

    /**
     * Бокс с животными закрылся.
     * @method onCloseBoxFromAnimal
     * @param {cc.Event} event
     */
    onCloseBoxFromAnimal(event){

        cc.log(&#x27;закрылся BoxFromAnimal&#x27;);
        if (this._stateGame != StatGame.createAnimal) {
            this.nodeMaskCreatedAnimal.active = false;
        }

    },

    /**
     * Бокс с животными открылся.
     * @method onOpenBoxFromAnimal
     * @param {cc.Event} event
     */
    onOpenBoxFromAnimal(event){

        cc.log(&#x27;открылся BoxFromAnimal&#x27;);
        this.nodeMaskCreatedAnimal.active = true;//активировали маску
        this.nodeMaskCreatedAnimal.setPosition(this._centreWindowPoint);
    },

    /**
     * Меню открылось.
     * @method onOpenBoxMenuPlay
     * @param {cc.Event} event
     */
    onOpenBoxMenuPlay(event){

        cc.log(&#x27;открылось меню&#x27;);
        this.nodeMenu.active = true;
    },

    /**
     * Меню закрылось.
     * @method onCloseBoxMenuPlay
     * @param {cc.Event} event
     */
    onCloseBoxMenuPlay(event){

        cc.log(&#x27;закрылось меню&#x27;);
        this.nodeMenu.active = false;
    },

    /**
     * Создание животного.
     * Отвечает за размещение животного в дереве нодов.
     * @method onAnimalCreated
     * @param {cc.Event} event
     */
    onAnimalCreated(event){
        this._stateGame = StatGame.createAnimal;
        cc.log(&#x27;создание нового животного&#x27;);
        event.detail.animal.parent = this.nodeFieldAnimals.parent;// подцепить животное к карте
        let point = this._controllerMap.getPointMap(cc.v2(this.node.width / 2, this.node.height / 2));//вычислить координаты на карте
        event.detail.animal.setPosition(point.x, point.y);//Установить координаты животного
        this._targetPuthToModel = event.detail.puthToModel;//Сохранить путь до модели. используется при создании модели

        this._boxCreateAnimal.closeBox();//закрыть бокс с животными
        this._boxCreateAnimal.onBlock();//заблокировать бокс сживотными
        this._controllerBasket.on();//Включить корзину
        this.nodeBoxMap.getComponent(cc.ScrollView).enabled = false;//заблокировать карту

        //Необходимо закрыть все что связано с прошлым фокусом
        if (this._targetAnimal != null) {

            this._controllerAnimal.closeMenu();//закрывает меню
            this._boxCharacteristicsAnimal.closeBox();//закрыть бокс с характеристиками
            this._targetAnimal = null;//обнуляет ссылку на нод животного в фокусе

        }
    },

    /**
     * Перетаскивание животного началось.
     * @method onStartDragAndDropAnimal
     * @param {cc.Event} event
     */
    onStartDragAndDropAnimal(event){

        cc.log(&#x27;запуск анимации подвешенности (старт перетаскивания)&#x27;);
        this._targetAnimal = event.detail.animal;//Берем нод животного в фокус
        this.nodeBoxMap.getComponent(cc.ScrollView).enabled = false;//заблокировать движение карты


    },

    /**
     * Перетаскивание нового животного.
     * Отвечает за перемещение нода животного по карте после создания и производит замеры до различных объектов на карте.
     * @method onDragAndDropAnimal
     * @param {cc.Event} event
     */
    onDragAndDropAnimal(event){

        cc.log(&#x27;сообщаем корзине положение зверюшки (перетаскивание)&#x27;);
        let point = this._controllerMap.getPointWindow(event.detail.point);
        this._controllerBasket.setPositionAnimal(point);
        this.nodeMaskCreatedAnimal.setPosition(point);
    },

    /**
     * Перетаскивание животного завершилось.
     * @method onStopDragAndDropAnimal
     * @param {cc.Event} event
     */
    onStopDragAndDropAnimal(event){

        cc.log(&#x27;определение дальнейших действий с животным (завершение перетаскивание)&#x27;);
        let point = this._controllerMap.getPointWindow(event.detail.point); //Запрашиваем точку в формате координаты окна

        if (this._controllerBasket.isAnimalLife(point)) {

            let model = this._api.createAnimal(this._targetPuthToModel, this.nodeFieldAnimals.children.length);//создаем модель животного
            let nodeModel = cc.instantiate(this._targetAnimal.children[0]);//создаем нод животного
            nodeModel.parent = this.nodeFieldAnimals;//Вешаем нод животного на нод со всеми животными
            nodeModel.setPosition(event.detail.point.x, event.detail.point.y);//Устанавливаем позицию на карте
            nodeModel.addComponent(&#x27;controller-animal&#x27;);//Добавляем контроллер телу животного
            nodeModel.getComponent(&#x27;controller-animal&#x27;).settings(model);//Настраивам контроллер животного
            this._controllerBasket.onBadWorkBasket();//Дать команду корзине(не сейчас)

        } else {
            this._controllerBasket.onGoodWorkBasket();//Дать команду корзине(работать)
        }

        this._targetAnimal.destroy();//Удалить временный нод животного
        this._controllerBasket.off();//вырубить корзину
        this._boxCreateAnimal.offBlock();//вырубить блокировку нижнего бокса
        this.nodeBoxMap.getComponent(cc.ScrollView).enabled = true;//разблокировать движение карты

        this._targetAnimal = null;//обнулить  животное в таргете
        this._targetPuthToModel = null;//обнулить путь до модели животного
        this.nodeMaskCreatedAnimal.active = false;
        this._stateGame = StatGame.sleep;
    },

    /**
     * Начало движения животного.
     * @method onStartMotionAnimal
     * @param {cc.Event} event
     */
    onStartMotionAnimal(event){
        //Закрываю меню иинформацию о животном если переключаюсь на другое животное
        if (this._targetAnimal != null &amp;&amp; this._targetAnimal._model.id != event.detail.controller._model.id) {
            this._controllerAnimal.closeMenu();//закрыть меню
        }

        cc.log(&#x27;начинаю двигаться за пользователем(Начинаю выюор двигаться или открыть меню)&#x27;);
        let point = this._controllerMap.getPointMap(event.detail.startMotion);//конвертируем точку окна к точку карты

        this._pointTargetAnimal = cc.v2(point.x, point.y);// задаем точку куда надо доставить животне
        this._controllerAnimal = event.detail.controller;//получаем контроллер животного в таргете
        this._targetAnimal = event.detail.controller;//установили нод животного на фокус

        this.nodeBoxMap.getComponent(cc.ScrollView).enabled = false;//заблокировать карту

        //увеличим поле отклика животного
        this._targetSizeWith = this._targetAnimal.node.width;
        this._targetSizeHeight = this._targetAnimal.node.height;
    },

    /**
     * Движение животного за ведущим.
     * @method onMotionAnimal
     * @param {cc.Event} event
     */
    onMotionAnimal(event){
        //обработка событий с животным во время движения
        cc.log(&#x27;двигаюсь за пользователем&#x27;);
        //увеличим поле отклика животного
        this._targetAnimal.node.width = 2000;
        this._targetAnimal.node.height = 2000;

    },

    /**
     * Окончание движения животного.
     * @method onEndMotionAnimal
     * @param {cc.Event} event
     */
    onEndMotionAnimal(event){
        cc.log(&#x27;заканчиваю двигаться за пользователем&#x27;);

        //уменьшаем площадь покрытия животного
        this._targetAnimal.node.width = this._targetSizeWith;
        this._targetAnimal.node.height = this._targetSizeHeight;

        let point = this._controllerMap.getPointMap(event.detail.pointEnd);// конвертируем точку окна к точке карты
        this._pointTargetAnimal = cc.v2(point.x, point.y);// вычисляем точку куда пойдет животное в итоге
        //сообщаем модели точку до которой необходимо ей дойти
        this._targetAnimal.moveToPoint(this._pointTargetAnimal);
        this.nodeBoxMap.getComponent(cc.ScrollView).enabled = true; // Разблокировали карту
    },

    /**
     * Меню животного открыто.
     * @method onOpenMenuAnimal
     * @param {cc.Event} event
     */
    onOpenMenuAnimal(event){
        cc.log(&#x27;Открываю меню животного&#x27;);
        //Центрировать животное
        let point = cc.v2(this._targetAnimal.node.x - this._centreWindowPoint.x, this._targetAnimal.node.y - this._centreWindowPoint.y);

        this._controllerMap.moveActions(point, 0.25);//переместить центр камеры на эту точку за 0.25 секунды

        //Устанавливаем настройки для меню
        this._controllerCircularMenu.settings(this._controllerAnimal);

        //заполнить бокс характеристик,,,

        this.nodeBoxMap.getComponent(cc.ScrollView).enabled = false;//заблокировать карту
        this._stateGame = StatGame.openMenu;
    },

    /**
     * Меню животного закрыто.
     * @method onCloseMenuAnimal
     * @param {cc.Event} event
     */
    onCloseMenuAnimal(event){

        cc.log(&#x27;Закрываю меню животного&#x27;);
        this.nodeMenuAnimal.active = false;
        this.nodeBoxMap.getComponent(cc.ScrollView).enabled = true;//разблокировать карту
        this._boxCharacteristicsAnimal.closeBox();
        this._targetAnimal = null;
        this._stateGame = StatGame.sleep;
    },

    /**
     * Животное издало звук.
     * @method onVoiceAnimal
     * @param {cc.Event} event
     */
    onVoiceAnimal(event){
        cc.log(&#x27;животное проявило голос&#x27;);

    },

    /**
     * Бокс характристик животного открылся.
     * @method onOpenBoxFromCharacteristicsAnimal
     * @param {cc.Event} event
     */
    onOpenBoxFromCharacteristicsAnimal(event){

        cc.log(&#x27;открылся BoxFromCharacteristicsAnimal&#x27;);

    },

    /**
     * Бокс характеристик животного закрылся.
     * @method onCloseBoxFromCharacteristicsAnimal
     * @param {cc.Event} event
     */
    onCloseBoxFromCharacteristicsAnimal(event){

        cc.log(&#x27;закрылся BoxFromCharacteristicsAnimal&#x27;);

    },

    /**
     * Корзина перешла в событие активного предвкушения.
     * @method onBasketActive
     * @param {cc.Event} event
     */
    onBasketActive(event){

        cc.log(&#x27;корзина проявляет активность&#x27;);

    },

    /**
     * Корзина перешла в режим сна.
     * @method onBasketSleep
     * @param {cc.Event} event
     */
    onBasketSleep(event){

        cc.log(&#x27;корзина спит&#x27;);
    },

    /**
     * Корзина перешла в режим работы (Вот вот сбросят животное).
     * @method onBasketWork
     * @param {cc.Event} event
     */
    onBasketWork(event){

        cc.log(&#x27;корзина надеется что вот вот в нее попадет животное&#x27;);

    },

    /**
     * Событие начала работы с картой.
     * @method onTouchOnMap
     * @param {cc.Event} event
     */
    onTouchOnMap(event){

        cc.log(&#x27;Начал работу с картой&#x27;);

    },

    /**
     * Событие движения карты.
     * @method onTouchMoveOnMap
     * @param {cc.Event} event
     */
    onTouchMoveOnMap(event){

        cc.log(&#x27;Двигает карту&#x27;);
    },

    /**
     * Событие завершения работы с картой.
     * @method onTouchEndMoveOnMap
     * @param {cc.Event} event
     */
    onTouchEndMoveOnMap(event){

        if (this._stateGame === StatGame.sleep) {
            cc.log(&#x27;завершил работу с картой&#x27;);
        }
    },

    /**
     * Наведение центра камеры на животное завершилось.
     * @method onFinishMoveCameraToAnimal
     * @param {cc.Event} event
     */
    onFinishMoveCameraToAnimal(event){

        this.nodeMenuAnimal.active = true;
        this.nodeMenuAnimal.setPosition(this._centreWindowPoint.x, this._centreWindowPoint.y);
        this._boxCharacteristicsAnimal.openBox();
    },

});
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
